# PostgreSQL Configuration for Primary (Streaming Replication)
# Production settings optimized for 50,000 trackers
# Assumes server with 32GB+ RAM and 16+ CPU cores

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================
listen_addresses = '*'
port = 5432
max_connections = 500                    # Increased for high concurrency
                                        # Consumers: ~50 connections (write operations)
                                        # Parsers: ~100 connections (read-only: unit_io_mapping, commands, feedback)
                                        # Dashboards: ~0 connections (use replica instead)
                                        # Monitoring: ~10 connections
                                        # Admin/backup: ~20 connections
                                        # Reserve: ~320 connections

# ============================================================================
# WAL SETTINGS (Required for Replication)
# ============================================================================
wal_level = replica                      # Minimum level for streaming replication
max_wal_senders = 5                      # Allow multiple replicas if needed
wal_keep_size = 3200                    # Keep 3.2GB of WAL files (for high write load)
max_replication_slots = 5               # Number of replication slots
wal_compression = on                     # Compress WAL to reduce I/O (PostgreSQL 13+)

# ============================================================================
# ARCHIVING (Recommended for Production)
# ============================================================================
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
# Note: Archive directory should be on separate volume for performance

# ============================================================================
# REPLICATION SETTINGS
# ============================================================================
hot_standby = off                        # Primary doesn't need hot standby
synchronous_commit = on                 # Ensure data durability
                                        # For extreme performance, can use 'off' or 'local'
                                        # but 'on' is recommended for production

# ============================================================================
# MEMORY SETTINGS (Optimized for 32GB+ RAM server)
# ============================================================================
shared_buffers = 8GB                     # 25% of total RAM (for 32GB server)
                                        # For 64GB server, use 16GB
effective_cache_size = 24GB              # 75% of total RAM (for 32GB server)
                                        # For 64GB server, use 48GB
work_mem = 16MB                          # Per operation memory
                                        # Formula: (RAM - shared_buffers) / (max_connections * 3)
                                        # With 32GB: (32GB - 8GB) / (500 * 3) â‰ˆ 16MB
maintenance_work_mem = 2GB               # For VACUUM, CREATE INDEX, etc.
temp_buffers = 8MB                       # Temporary table buffers

# ============================================================================
# WRITE PERFORMANCE (Optimized for High Write Load)
# ============================================================================
# Checkpoint settings - critical for write performance
checkpoint_timeout = 15min               # Time between checkpoints
max_wal_size = 8GB                      # Maximum WAL size before forced checkpoint
min_wal_size = 2GB                      # Minimum WAL size to keep
checkpoint_completion_target = 0.9      # Spread checkpoint I/O over 90% of interval
                                        # Reduces I/O spikes

# WAL buffers
wal_buffers = 64MB                       # Increased for high write load
                                        # Default is 16MB

# Background writer
bgwriter_delay = 200ms                   # Delay between background writer rounds
bgwriter_lru_maxpages = 1000            # Maximum pages written per round
bgwriter_lru_multiplier = 10.0          # Multiplier for pages to write

# ============================================================================
# QUERY PERFORMANCE
# ============================================================================
random_page_cost = 1.1                   # For SSD storage (default 4.0 is for HDD)
effective_io_concurrency = 200           # For SSD storage (default 1 is for HDD)
seq_page_cost = 1.0                      # Sequential page cost

# Planner settings
default_statistics_target = 500          # Increased for better query plans (default 100)
                                        # Higher value = more accurate statistics
                                        # Trade-off: slower ANALYZE, better plans

# Join settings
join_collapse_limit = 12                 # Maximum joins to consider
from_collapse_limit = 12                 # Maximum FROM items to consider

# ============================================================================
# AUTOVACUUM (Critical for High Write Load)
# ============================================================================
autovacuum = on                          # Enable autovacuum
autovacuum_max_workers = 6               # Number of autovacuum workers (default 3)
                                        # For high write load, increase workers
autovacuum_naptime = 10s                 # Time between autovacuum runs (default 1min)
                                        # More frequent for high write load
autovacuum_vacuum_threshold = 50         # Minimum number of updated tuples
autovacuum_analyze_threshold = 50        # Minimum number of inserted/updated tuples
autovacuum_vacuum_scale_factor = 0.05    # Fraction of table size before vacuum
autovacuum_analyze_scale_factor = 0.02   # Fraction of table size before analyze
autovacuum_vacuum_cost_delay = 2ms       # Cost-based vacuum delay
autovacuum_vacuum_cost_limit = 2000      # Cost limit per autovacuum worker

# ============================================================================
# LOGGING (Production Best Practices)
# ============================================================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 500MB                # Increased for high load
log_truncate_on_rotation = on            # Truncate logs on rotation (prevents indefinite growth)
log_min_duration_statement = 1000       # Log slow queries (>1 second)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on                     # Log checkpoints
log_connections = on                     # Log connections (can disable in production)
log_disconnections = on                  # Log disconnections
log_lock_waits = on                      # Log lock waits
log_temp_files = 0                       # Log all temporary files
log_autovacuum_min_duration = 0          # Log all autovacuum operations

# ============================================================================
# ERROR REPORTING
# ============================================================================
log_min_messages = warning               # Minimum message level to log
log_error_verbosity = default            # Error detail level

# ============================================================================
# TIMESCALEDB SPECIFIC (if using TimescaleDB)
# ============================================================================
# TimescaleDB automatically uses these settings, but can be tuned:
timescaledb.max_background_workers = 8   # Background workers for compression, etc.

# ============================================================================
# SECURITY (Production Best Practices)
# ============================================================================
ssl = off                                # Enable SSL in production with certificates
                                        # For internal Docker network, SSL may not be needed
password_encryption = scram-sha-256      # Use SCRAM-SHA-256 password encryption

# ============================================================================
# LOCALE AND FORMATTING
# ============================================================================
timezone = 'UTC'                         # Use UTC for consistency
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog'

# ============================================================================
# PERFORMANCE MONITORING
# ============================================================================
track_activities = on                    # Track query execution
track_counts = on                        # Track table/index statistics
track_io_timing = on                     # Track I/O timing (requires track_activities)
track_functions = all                    # Track function call statistics

# ============================================================================
# SHARED PRELOAD LIBRARIES (Required for TimescaleDB)
# ============================================================================
# TimescaleDB must be preloaded before the database starts
# pg_stat_statements enabled for query performance monitoring
shared_preload_libraries = 'timescaledb,pg_stat_statements'

# ============================================================================
# STATEMENT STATISTICS (for pg_stat_statements extension)
# ============================================================================
# pg_stat_statements enabled for query performance monitoring
pg_stat_statements.max = 10000
pg_stat_statements.track = all
