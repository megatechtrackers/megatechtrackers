# PostgreSQL Configuration for Replica (Hot Standby)
# Production settings optimized for 50,000 trackers
# Assumes server with 32GB+ RAM and 16+ CPU cores
# Replica handles read-only queries from parser nodes

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================
listen_addresses = '*'
port = 5432
max_connections = 500                    # Must be >= primary (500)
                                        # Replica for dashboards only
                                        # Dashboards: ~100-150 connections (read-only queries)
                                        # Monitoring: ~10 connections
                                        # Admin: ~20 connections
                                        # Reserve: ~320+ connections
                                        # NOTE: Parser nodes do NOT use replica
                                        # Must match or exceed primary max_connections

# ============================================================================
# WAL SETTINGS
# ============================================================================
wal_level = replica
max_wal_senders = 5                      # Must be >= primary (5) for replication
                                        # Even though replica doesn't send WAL,
                                        # this setting must match or exceed primary
wal_keep_size = 0                        # Replica doesn't need to keep WAL

# ============================================================================
# HOT STANDBY (Required for read queries on replica)
# ============================================================================
hot_standby = on                         # Enable read queries on replica
hot_standby_feedback = on                 # Inform primary about queries
                                        # Helps primary avoid vacuum conflicts
max_standby_streaming_delay = 30s        # Max delay before canceling queries
                                        # If replica falls behind, queries may be canceled
max_standby_archive_delay = 300s         # Max delay for archived WAL
                                        # Longer delay for archived WAL (less critical)

# ============================================================================
# MEMORY SETTINGS (Optimized for 32GB+ RAM server)
# ============================================================================
shared_buffers = 8GB                     # 25% of total RAM (same as primary)
effective_cache_size = 24GB              # 75% of total RAM (same as primary)
work_mem = 20MB                          # Slightly higher for read queries
                                        # (RAM - shared_buffers) / (max_connections * 3)
                                        # (32GB - 8GB) / (300 * 3) â‰ˆ 20MB
maintenance_work_mem = 2GB               # For maintenance operations
temp_buffers = 8MB                       # Temporary table buffers

# ============================================================================
# CHECKPOINT SETTINGS
# ============================================================================
checkpoint_timeout = 15min
max_wal_size = 8GB
min_wal_size = 2GB
checkpoint_completion_target = 0.9
wal_buffers = 64MB                       # Same as primary

# ============================================================================
# QUERY PERFORMANCE (Same as Primary)
# ============================================================================
random_page_cost = 1.1                   # For SSD storage
effective_io_concurrency = 200           # For SSD storage
seq_page_cost = 1.0
default_statistics_target = 500          # Better query plans
join_collapse_limit = 12
from_collapse_limit = 12

# ============================================================================
# AUTOVACUUM (Replica doesn't write, but still needs autovacuum for stats)
# ============================================================================
autovacuum = on
autovacuum_max_workers = 4               # Fewer workers needed (read-only)
autovacuum_naptime = 30s                 # Less frequent (read-only)
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1     # Less aggressive (read-only)
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 2000

# ============================================================================
# LOGGING (Production Best Practices)
# ============================================================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 500MB
log_min_duration_statement = 1000       # Log slow queries
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# Replica-specific logging
log_replication_commands = on            # Log replication commands
log_recovery_conflict_waits = on         # Log recovery conflicts

# ============================================================================
# ERROR REPORTING
# ============================================================================
log_min_messages = warning
log_error_verbosity = default

# ============================================================================
# SHARED PRELOAD LIBRARIES (Required for TimescaleDB)
# ============================================================================
# TimescaleDB must be preloaded before the database starts
# pg_stat_statements enabled for query performance monitoring
shared_preload_libraries = 'timescaledb,pg_stat_statements'

# ============================================================================
# TIMESCALEDB SPECIFIC
# ============================================================================
timescaledb.max_background_workers = 6   # Fewer workers for replica

# ============================================================================
# STATEMENT STATISTICS (for pg_stat_statements extension)
# ============================================================================
# pg_stat_statements enabled for query performance monitoring
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# ============================================================================
# SECURITY
# ============================================================================
ssl = off                                # Enable SSL in production
password_encryption = scram-sha-256

# ============================================================================
# LOCALE AND FORMATTING
# ============================================================================
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog'

# ============================================================================
# PERFORMANCE MONITORING
# ============================================================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
