events {
    worker_connections 1024;
}

http {
    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
    
    # Cache static assets
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=grafana_cache:10m max_size=100m inactive=60m use_temp_path=off;
    
    # Upstream servers
    upstream grafana {
        server grafana:3000;
        keepalive 32;
    }

    upstream access-gateway {
        # Run access-gateway as a container on the same Docker network
        server access-gateway:3001;
        keepalive 32;
    }

    # Logging (reduced for performance)
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    server {
        listen 3000;
        server_name localhost;

        # Grafana Live WebSocket (required for live refresh / streaming)
        # Must include auth for Grafana 11+
        location /api/live/ {
            proxy_pass http://grafana;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Basic Auth for Grafana API (admin:admin = YWRtaW46YWRtaW4=)
            proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
            # WebSocket-specific settings for long-lived connections
            proxy_buffering off;
            proxy_read_timeout 86400s;   # 24 hours - WebSocket can stay open
            proxy_send_timeout 86400s;   # 24 hours
            proxy_connect_timeout 10s;
        }

        # Health check endpoint (no validation needed)
        location /api/health {
            proxy_pass http://grafana;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Grafana API endpoints that require authentication (Grafana 11+)
        # Plugin settings, frontend metrics, etc.
        location /api/ {
            proxy_pass http://grafana;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            # Basic Auth for Grafana API (admin:admin = YWRtaW46YWRtaW4=)
            proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        }

        # Grafana v1beta1 APIs (dashboard.grafana.app, etc.) - Grafana 11+
        location /apis/ {
            proxy_pass http://grafana;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            # Basic Auth for Grafana API (admin:admin = YWRtaW46YWRtaW4=)
            proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        }

        # Dashboard requests - proxy through validation service
        # The service will validate the token and proxy to Grafana if valid
        location ~ ^/d/ {
            # Forward to Access Gateway for validation + proxying
            proxy_pass http://access-gateway/api/grafana/proxy$request_uri;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 10s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }

        # Static assets with caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://grafana;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache grafana_cache;
            proxy_cache_valid 200 60m;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            add_header X-Cache-Status $upstream_cache_status;
            expires 1h;
            access_log off;
        }
        
        # All other Grafana routes (static files, public assets)
        location / {
            proxy_pass http://grafana;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
        }
    }
}
