# HAProxy configuration for Teltonika Tracker Load Balancing
# TCP Layer 4 load balancing across all parser nodes

global
    maxconn 30000
    log stdout format raw local0
    
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    timeout connect 10s
    timeout client 120s
    timeout server 120s
    retries 3
    
# Frontend - Listen for tracker connections
frontend tracker_frontend
    bind *:2001
    maxconn 25000
    mode tcp
    
    # Connection rate limiting (prevent DDoS) - disabled for load testing
    # stick-table type ip size 100k expire 30s store conn_cur,conn_rate(3s)
    # tcp-request connection track-sc1 src
    # tcp-request connection reject if { sc1_conn_rate gt 20 }
    
    default_backend tracker_backend

# Backend - Parser nodes 2-8 (node 1 reserved for real trackers on port 2001)
backend tracker_backend
    mode tcp
    balance roundrobin
    
    # Health check - TCP connect
    option tcp-check
    
    # Parser nodes 2-8 (NOT node 1 - reserved for real trackers)
    server parser2 parser-service-2:5027 check inter 5s rise 2 fall 3
    server parser3 parser-service-3:5027 check inter 5s rise 2 fall 3
    server parser4 parser-service-4:5027 check inter 5s rise 2 fall 3
    server parser5 parser-service-5:5027 check inter 5s rise 2 fall 3
    server parser6 parser-service-6:5027 check inter 5s rise 2 fall 3
    server parser7 parser-service-7:5027 check inter 5s rise 2 fall 3
    server parser8 parser-service-8:5027 check inter 5s rise 2 fall 3

# Stats page for monitoring
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats admin if TRUE
    stats show-legends
    stats show-node
